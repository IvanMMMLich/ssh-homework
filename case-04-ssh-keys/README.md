# Кейс 4: Работа с SSH ключами

## Что нужно было сделать
Сгенерировать пару SSH ключей, добавить публичный ключ на сервер и настроить безпарольный вход через ключи.

## Зачем это нужно
SSH ключи - это основа безопасности в современной разработке! Они:
1. **Безопаснее паролей** - невозможно подобрать
2. **Удобнее** - не нужно вводить пароль каждый раз
3. **Позволяют автоматизацию** - скрипты могут работать без ввода пароля

## Что такое SSH ключи

SSH использует **асимметричную криптографию** - пару связанных ключей:

**Приватный ключ (id_ed25519):**
- Хранится ТОЛЬКО у тебя
- НИКОГДА никому не показывай
- Это как ключ от двери

**Публичный ключ (id_ed25519.pub):**
- Можно показывать всем
- Копируешь на серверы
- Это как замок на двери

**Как работает:**
1. Ты вешаешь "замок" (публичный ключ) на сервер
2. Сервер требует "ключ от замка" при входе
3. Ты показываешь свой приватный ключ
4. Сервер проверяет математически: подходит ли ключ к замку?
5. Если да - пускает без пароля!

**Почему безопасно:**
Из публичного ключа НЕВОЗМОЖНО получить приватный! Это односторонняя математическая функция. Даже на суперкомпьютере уйдут миллионы лет.

## Как я это делал

### Шаг 1: Проверил существующие ключи

У меня уже были созданы ключи для GitHub, поэтому не стал создавать новые:
```bash
ls -la ~/.ssh/
```

**Результат:**
```
-rw-------  1 ivansycev  staff  464 Oct 23 23:13 id_ed25519
-rw-r--r--  1 ivansycev  staff  106 Oct 23 23:13 id_ed25519.pub
```

Видно два файла:
- `id_ed25519` - приватный ключ (права 600 - только я могу читать)
- `id_ed25519.pub` - публичный ключ (права 644 - все могут читать)

**Если бы нужно было создать новые ключи:**
```bash
ssh-keygen -t ed25519 -C "your-email@example.com"
```

---

### Шаг 2: Посмотрел публичный ключ
```bash
cat ~/.ssh/id_ed25519.pub
```

**Результат:**
```
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFMuRfBar2cdr/BxKPwVvL6yk4k81acC51uGgHUuFOxl Sychovivanivan15@mail.ru
```

Это одна строка текста - мой публичный ключ. Его можно безопасно показывать.

**Для сравнения посмотрел приватный ключ:**
```bash
cat ~/.ssh/id_ed25519
```

Он выглядит совершенно иначе - несколько строк между:
```
-----BEGIN OPENSSH PRIVATE KEY-----
...много строк зашифрованных данных...
-----END OPENSSH PRIVATE KEY-----
```

**Вывод:** Это два РАЗНЫХ файла с разным содержимым, а не просто разные названия!

---

### Шаг 3: Добавил публичный ключ на сервер

Использовал команду `ssh-copy-id` которая автоматически копирует ключ:
```bash
ssh-copy-id ivansycev@localhost
```

**Что произошло:**
```
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/Users/ivansycev/.ssh/id_ed25519.pub"
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
(ivansycev@localhost) Password: 
Number of key(s) added: 1
Now try logging into the machine, with: "ssh 'ivansycev@localhost'"
and check to make sure that only the key(s) you wanted were added.
```

**Что делает ssh-copy-id:**
1. Читает мой публичный ключ из `~/.ssh/id_ed25519.pub`
2. Подключается к серверу (попросил пароль **В ПОСЛЕДНИЙ РАЗ!**)
3. Добавляет ключ в файл `~/.ssh/authorized_keys` на сервере
4. Сообщает что 1 ключ добавлен

---

### Шаг 4: Проверил безпарольный вход

Попробовал подключиться:
```bash
ssh localhost
```

**МАГИЯ!**   
Подключился **БЕЗ ВВОДА ПАРОЛЯ!**

**Результат:**
```
Last login: Fri Oct 24 00:25:45 2025 from ::1
```

Внутри SSH проверил:
```bash
whoami      # ivansycev
hostname    # MacBook-Air-Ivan-2.local
```

Все работает! Вышел:
```bash
exit
```

---

### Шаг 5: Проверил что ключ добавлен на сервер
```bash
cat ~/.ssh/authorized_keys
```

**Результат:**
```
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFMuRfBar2cdr/BxKPwVvL6yk4k81acC51uGgHUuFOxl Sychovivanivan15@mail.ru
```

Мой публичный ключ теперь в файле `authorized_keys`! Этот файл содержит список всех ключей, которым разрешен доступ к серверу.

---

## Итог

 Проверил существующие SSH ключи (id_ed25519 и id_ed25519.pub)  
 Понял разницу между приватным и публичным ключом  
 Добавил публичный ключ на сервер через ssh-copy-id  
 Настроил безпарольный вход - теперь вход без пароля!  
 Проверил что ключ в файле authorized_keys

**Больше не нужно вводить пароль при каждом подключении!** Это огромная экономия времени и повышение безопасности.

## Основные команды
```bash
# Генерация новой пары ключей (если нужно)
ssh-keygen -t ed25519 -C "your-email@example.com"

# Просмотр публичного ключа
cat ~/.ssh/id_ed25519.pub

# Копирование ключа на сервер
ssh-copy-id user@server

# Подключение (теперь без пароля!)
ssh user@server

# Просмотр установленных ключей на сервере
cat ~/.ssh/authorized_keys
```

## Как работает ssh-copy-id
```bash
ssh-copy-id user@server
```

Эта команда:
1. Читает твой публичный ключ из `~/.ssh/id_ed25519.pub`
2. Подключается к серверу (попросит пароль в последний раз)
3. Создает папку `~/.ssh` на сервере если её нет
4. Добавляет ключ в файл `~/.ssh/authorized_keys`
5. Устанавливает правильные права доступа (700 для папки, 600 для файла)

## В реальной работе

В production окружении команды выглядят так:
```bash
# Генерация ключа для работы
ssh-keygen -t ed25519 -C "work-laptop"

# Добавление на production сервер
ssh-copy-id admin@production-server.com

# Подключение без пароля
ssh admin@production-server.com
```

## Безопасность

**ВАЖНО:**
- ❌ НИКОГДА не показывай приватный ключ (id_ed25519)
- ❌ НИКОГДА не коммить приватный ключ в git
- ✅ Публичный ключ (.pub) можно показывать всем
- ✅ Используй разные ключи для разных целей (работа, личное)
- ✅ Можно добавить passphrase на ключ для дополнительной защиты

**Права доступа должны быть строгими:**
```bash
chmod 700 ~/.ssh              # Папка - только владелец
chmod 600 ~/.ssh/id_ed25519   # Приватный ключ - только владелец
chmod 644 ~/.ssh/id_ed25519.pub  # Публичный ключ - все могут читать
```
